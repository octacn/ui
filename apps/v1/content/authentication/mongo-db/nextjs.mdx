---
title: Nextjs - Auth Guide
description: This guide will take you through building a complete full-stack application with user authentication, database management, and secure API endpoints.
---

_By the end of this guide, you'll have:_
- âœ… A fully configured Next.js application with TypeScript
- âœ… MongoDB database with proper schemas and validation
- âœ… Complete authentication system (credentials + OAuth)
- âœ… Protected routes and middleware
- âœ… Professional UI components for auth forms
- âœ… Error handling and validation
- âœ… Production-ready deployment configuration

## Prerequisites
Before starting, make sure you have:
- Node.js 18+ installed
- Basic knowledge of React and TypeScript
- A MongoDB Atlas account (free tier available)
- Code editor (VS Code recommended)

---
## 1. Project Setup

### Initialize Project

Let's start by creating a new Next.js project with the optimal configuration for our full-stack application.

```bash
npx create-next-app@latest my-auth-app
```

```bash
âœ” Would you like to use TypeScript? â€¦ Yes
âœ” Would you like to use ESLint? â€¦ Yes  
âœ” Would you like to use Tailwind CSS? â€¦ Yes
âœ” Would you like to use `src/` directory? â€¦ Yes
âœ” Would you like to use App Router? â€¦ Yes
âœ” Would you like to customize the default import alias (@/*)? â€¦ No
```

```bash
cd my-auth-app
```

### Install Dependencies

We'll install all the packages needed for authentication, database connectivity, validation, and UI components.

```bash
npm install next-auth@beta mongoose bcryptjs zod react-hook-form @hookform/resolvers sonner next-themes axios
```

- **next-auth@beta**: Complete authentication solution for Next.js
- **mongoose**: MongoDB object modeling library
- **bcryptjs**: Password hashing and comparison
- **zod**: TypeScript-first schema validation
- **react-hook-form**: Performant forms library
- **@hookform/resolvers**: Form validation resolvers
- **sonner**: Beautiful toast notifications
- **next-themes**: Theme switching functionality
- **axios**: HTTP client for API calls

### .env Configuration
Create a `.env.local` file in your project root with the following configuration:

```env
# NextAuth Configuration
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=your-super-secure-secret-key-here

# MongoDB Configuration  
MONGODB_URI=mongodb+srv://<username>:<password>@cluster0.xxxxx.mongodb.net/<database>?retryWrites=true&w=majority

# OAuth Providers (Optional)
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret

GITHUB_ID=your-github-client-id
GITHUB_SECRET=your-github-client-secret
```

---

## 2. Database Configuration

### MongoDB Atlas Setup

<Steps>
  <Step>
    **Create MongoDB Atlas Account**
    
    Visit [MongoDB Atlas](https://www.mongodb.com/atlas) and create a free account.
  </Step>
  
  <Step>
    **Create a Cluster**
    
    - Choose the free tier (M0 Sandbox)
    - Select your preferred region
    - Name your cluster (e.g., "Cluster0")
  </Step>
  
  <Step>
    **Configure Database Access**
    
    - Go to "Database Access" in the sidebar
    - Click "Add New Database User"
    - Create a username and secure password
    - Set permissions to "Read and write to any database"
  </Step>
  
  <Step>
    **Configure Network Access**
    
    - Go to "Network Access" in the sidebar  
    - Click "Add IP Address"
    - For development, you can use "0.0.0.0/0" (allow access from anywhere)
    - For production, restrict to specific IP addresses
  </Step>
  
  <Step>
    **Get Connection String**
    
    - Go to "Clusters" and click "Connect"
    - Choose "Connect your application"
    - Copy the connection string
    - Replace `<password>` with your database user password
  </Step>
</Steps>

### Connection Setup

Create the database connection utility at `src/lib/mongodb.ts`:

<CodeCollapsibleWrapper>
  ```typescript
  import mongoose from "mongoose";

  type ConnectionObject = {
    isConnected?: boolean;
  };

  const connection: ConnectionObject = {};

  async function dbConnect(): Promise<void> {
    // Check if we have a connection to the database or if it's currently connecting
    if (connection.isConnected) {
      console.log("Already connected to MongoDB");
      return;
    }

    const mongoUri = process.env.MONGODB_URI;

    if (!mongoUri) {
      throw new Error("Please define the MONGODB_URI environment variable");
    }

    try {
      // Attempt to connect to the database
      const db = await mongoose.connect(mongoUri, {
        bufferCommands: false,
      });

      connection.isConnected = db.connections[0].readyState === 1;

      console.log("MongoDB connected successfully");
    } catch (error) {
      console.error("Database connection failed:", error);
      
      // Exit process with failure
      process.exit(1);
    }
  }

  export default dbConnect;
  ```
</CodeCollapsibleWrapper>

### User Model Schema

Create the user model at `src/models/User.ts`:

<CodeCollapsibleWrapper>
  ```typescript
  import mongoose, { Schema, Document } from "mongoose";

  export interface IUser extends Document {
    _id: string;
    username: string;
    email: string;
    password?: string;
    role: "user" | "admin";
    emailVerified?: Date;
    image?: string;
    provider?: string;
    createdAt: Date;
    updatedAt: Date;
  }

  const UserSchema: Schema<IUser> = new Schema({
    username: {
      type: String,
      required: [true, "Username is required"],
      trim: true,
      minlength: [2, "Username must be at least 2 characters"],
      maxlength: [50, "Username cannot exceed 50 characters"],
    },
    email: {
      type: String,
      required: [true, "Email is required"],
      unique: true,
      lowercase: true,
      match: [
        /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/,
        "Please enter a valid email address",
      ],
    },
    password: {
      type: String,
      minlength: [6, "Password must be at least 6 characters"],
    },
    role: {
      type: String,
      enum: ["user", "admin"],
      default: "user",
    },
    emailVerified: {
      type: Date,
    },
    image: {
      type: String,
    },
    provider: {
      type: String,
      enum: ["credentials", "google", "github"],
      default: "credentials",
    },
  }, {
    timestamps: true,
  });

  // Index for better query performance
  UserSchema.index({ email: 1 });
  UserSchema.index({ username: 1 });

  const UserModel = 
    (mongoose.models?.User as mongoose.Model<IUser>) ||
    mongoose.model<IUser>("User", UserSchema);

  export default UserModel;
  ```
</CodeCollapsibleWrapper>

---

## 3. Authentication Setup

### NextAuth Configuration

Create the NextAuth configuration at `src/app/api/auth/[...nextauth]/route.ts`:

<CodeCollapsibleWrapper>
  ```typescript
  import NextAuth, { type DefaultSession } from "next-auth";
  import { MongoDBAdapter } from "@auth/mongodb-adapter";
  import CredentialsProvider from "next-auth/providers/credentials";
  import GoogleProvider from "next-auth/providers/google";
  import GitHubProvider from "next-auth/providers/github";
  import { MongoClient } from "mongodb";
  import bcrypt from "bcryptjs";
  import dbConnect from "@/lib/mongodb";
  import UserModel from "@/models/User";

  // Extend the built-in session types
  declare module "next-auth" {
    interface Session extends DefaultSession {
      user: {
        id: string;
        username: string;
        role: string;
      } & DefaultSession["user"];
    }

    interface User {
      username: string;
      role: string;
    }
  }

  const client = new MongoClient(process.env.MONGODB_URI!);
  const clientPromise = client.connect();

  const handler = NextAuth({
    adapter: MongoDBAdapter(clientPromise),
    
    providers: [
      // Credentials Provider for email/password login
      CredentialsProvider({
        id: "credentials",
        name: "credentials",
        credentials: {
          email: { label: "Email", type: "email" },
          password: { label: "Password", type: "password" }
        },
        async authorize(credentials) {
          await dbConnect();

          if (!credentials?.email || !credentials?.password) {
            throw new Error("Email and password are required");
          }

          try {
            const user = await UserModel.findOne({ 
              email: credentials.email.toLowerCase() 
            });

            if (!user) {
              throw new Error("No user found with this email");
            }

            if (!user.password) {
              throw new Error("Password login not available for this account");
            }

            const isPasswordCorrect = await bcrypt.compare(
              credentials.password,
              user.password
            );

            if (!isPasswordCorrect) {
              throw new Error("Incorrect password");
            }

            return {
              id: user._id.toString(),
              email: user.email,
              username: user.username,
              role: user.role,
              image: user.image,
            };
          } catch (error) {
            console.error("Authentication error:", error);
            throw error;
          }
        }
      }),

      // Google OAuth Provider
      GoogleProvider({
        clientId: process.env.GOOGLE_CLIENT_ID!,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
      }),

      // GitHub OAuth Provider  
      GitHubProvider({
        clientId: process.env.GITHUB_ID!,
        clientSecret: process.env.GITHUB_SECRET!,
      }),
    ],

    session: {
      strategy: "jwt",
      maxAge: 30 * 24 * 60 * 60, // 30 days
    },

    jwt: {
      maxAge: 30 * 24 * 60 * 60, // 30 days
    },

    callbacks: {
      async jwt({ token, user }) {
        if (user) {
          token.username = user.username;
          token.role = user.role;
        }
        return token;
      },

      async session({ session, token }) {
        if (token) {
          session.user.id = token.sub!;
          session.user.username = token.username as string;
          session.user.role = token.role as string;
        }
        return session;
      },

      async signIn({ user, account, profile }) {
        if (account?.provider !== "credentials") {
          await dbConnect();
          
          try {
            const existingUser = await UserModel.findOne({ 
              email: user.email 
            });

            if (!existingUser) {
              await UserModel.create({
                username: user.name || user.email?.split("@")[0],
                email: user.email,
                image: user.image,
                provider: account?.provider,
                emailVerified: new Date(),
              });
            }
          } catch (error) {
            console.error("Error creating user:", error);
            return false;
          }
        }
        return true;
      },
    },

    pages: {
      signIn: "/auth/signin",
      error: "/auth/error",
    },

    events: {
      async createUser({ user }) {
        console.log(`New user created: ${user.email}`);
      },
      async signIn({ user, account, isNewUser }) {
        console.log(`User signed in: ${user.email} via ${account?.provider}`);
      },
    },
  });

  export { handler as GET, handler as POST };
  ```
</CodeCollapsibleWrapper>

### Registration API Route

Create the registration API at `src/app/api/auth/register/route.ts`:

<CodeCollapsibleWrapper>
  ```typescript
  import { NextRequest, NextResponse } from "next/server";
  import bcrypt from "bcryptjs";
  import { z } from "zod";
  import dbConnect from "@/lib/mongodb";
  import UserModel from "@/models/User";

  // Validation schema
  const registerSchema = z.object({
    username: z
      .string()
      .min(2, "Username must be at least 2 characters")
      .max(50, "Username cannot exceed 50 characters")
      .regex(/^[a-zA-Z0-9_]+$/, "Username can only contain letters, numbers, and underscores"),
    email: z.string().email("Invalid email address"),
    password: z
      .string()
      .min(8, "Password must be at least 8 characters")
      .regex(
        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,
        "Password must contain at least one uppercase letter, one lowercase letter, and one number"
      ),
  });

  export async function POST(request: NextRequest) {
    try {
      const body = await request.json();
      
      // Validate request data
      const validatedData = registerSchema.parse(body);
      const { username, email, password } = validatedData;

      // Connect to database
      await dbConnect();

      // Check if user already exists
      const existingUser = await UserModel.findOne({
        $or: [
          { email: email.toLowerCase() },
          { username: username }
        ]
      });

      if (existingUser) {
        if (existingUser.email === email.toLowerCase()) {
          return NextResponse.json(
            { error: "User with this email already exists" },
            { status: 409 }
          );
        } else {
          return NextResponse.json(
            { error: "Username is already taken" },
            { status: 409 }
          );
        }
      }

      // Hash password
      const saltRounds = 12;
      const hashedPassword = await bcrypt.hash(password, saltRounds);

      // Create new user
      const newUser = await UserModel.create({
        username,
        email: email.toLowerCase(),
        password: hashedPassword,
        provider: "credentials",
      });

      // Return success response (without password)
      return NextResponse.json(
        {
          message: "User created successfully",
          user: {
            id: newUser._id,
            username: newUser.username,
            email: newUser.email,
            role: newUser.role,
          },
        },
        { status: 201 }
      );

    } catch (error) {
      console.error("Registration error:", error);

      if (error instanceof z.ZodError) {
        return NextResponse.json(
          {
            error: "Validation failed",
            details: error.errors.map(err => ({
              field: err.path.join("."),
              message: err.message,
            })),
          },
          { status: 400 }
        );
      }

      return NextResponse.json(
        { error: "Internal server error" },
        { status: 500 }
      );
    }
  }
  ```
</CodeCollapsibleWrapper>

### Authentication Utilities

Create authentication utilities at `src/lib/auth-utils.ts`:

<CodeCollapsibleWrapper>
  ```typescript
  import { getServerSession } from "next-auth";
  import { NextRequest } from "next/server";
  import { authOptions } from "@/app/api/auth/[...nextauth]/route";

  export async function getSession() {
    return await getServerSession(authOptions);
  }

  export async function getCurrentUser() {
    const session = await getSession();
    return session?.user;
  }

  export async function requireAuth() {
    const session = await getSession();
    
    if (!session?.user) {
      throw new Error("Authentication required");
    }
    
    return session.user;
  }

  export async function requireRole(role: string) {
    const user = await requireAuth();
    
    if (user.role !== role) {
      throw new Error(`${role} role required`);
    }
    
    return user;
  }

  // Client-side auth hook
  export function useAuthRequired() {
    const { data: session, status } = useSession();
    
    if (status === "loading") return { loading: true };
    
    if (!session) {
      throw new Error("Authentication required");
    }
    
    return { user: session.user, loading: false };
  }
  ```
</CodeCollapsibleWrapper>

---

## 4. Frontend Implementation

### Session Provider

First, create the session provider at `src/components/providers/SessionProvider.tsx`:

<CodeCollapsibleWrapper>
  ```typescript
  "use client";

  import { SessionProvider as NextAuthSessionProvider } from "next-auth/react";
  import { ReactNode } from "react";

  interface Props {
    children: ReactNode;
  }

  export default function SessionProvider({ children }: Props) {
    return (
      <NextAuthSessionProvider>
        {children}
      </NextAuthSessionProvider>
    );
  }
  ```
</CodeCollapsibleWrapper>

Update your root layout at `src/app/layout.tsx`:

<CodeCollapsibleWrapper>
  ```typescript
  import { Inter } from "next/font/google";
  import "./globals.css";
  import SessionProvider from "@/components/providers/SessionProvider";
  import { Toaster } from "sonner";

  const inter = Inter({ subsets: ["latin"] });

  export default function RootLayout({
    children,
  }: {
    children: React.ReactNode;
  }) {
    return (
      <html lang="en">
        <body className={inter.className}>
          <SessionProvider>
            {children}
            <Toaster position="top-right" />
          </SessionProvider>
        </body>
      </html>
    );
  }
  ```
</CodeCollapsibleWrapper>

### Authentication Forms

Create the authentication form component at `src/components/auth/AuthForm.tsx`:

<CodeCollapsibleWrapper>
  ```typescript
  "use client";

  import { useState } from "react";
  import { useForm } from "react-hook-form";
  import { zodResolver } from "@hookform/resolvers/zod";
  import { z } from "zod";
  import { signIn, getSession } from "next-auth/react";
  import { useRouter } from "next/navigation";
  import { toast } from "sonner";
  import Link from "next/link";

  // Validation schemas
  const loginSchema = z.object({
    email: z.string().email("Invalid email address"),
    password: z.string().min(1, "Password is required"),
  });

  const registerSchema = z.object({
    username: z
      .string()
      .min(2, "Username must be at least 2 characters")
      .max(50, "Username cannot exceed 50 characters")
      .regex(/^[a-zA-Z0-9_]+$/, "Username can only contain letters, numbers, and underscores"),
    email: z.string().email("Invalid email address"),
    password: z
      .string()
      .min(8, "Password must be at least 8 characters")
      .regex(
        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,
        "Password must contain at least one uppercase letter, one lowercase letter, and one number"
      ),
    confirmPassword: z.string(),
  }).refine(data => data.password === data.confirmPassword, {
    message: "Passwords don't match",
    path: ["confirmPassword"],
  });

  type LoginFormData = z.infer<typeof loginSchema>;
  type RegisterFormData = z.infer<typeof registerSchema>;

  interface Props {
    mode: "login" | "register";
  }

  export default function AuthForm({ mode }: Props) {
    const [isLoading, setIsLoading] = useState(false);
    const router = useRouter();

    const schema = mode === "login" ? loginSchema : registerSchema;
    
    const {
      register,
      handleSubmit,
      formState: { errors },
      reset
    } = useForm<LoginFormData | RegisterFormData>({
      resolver: zodResolver(schema),
    });

    const onSubmit = async (data: LoginFormData | RegisterFormData) => {
      setIsLoading(true);

      try {
        if (mode === "register") {
          // Registration
          const registerData = data as RegisterFormData;
          
          const response = await fetch("/api/auth/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              username: registerData.username,
              email: registerData.email,
              password: registerData.password,
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || "Registration failed");
          }

          toast.success("Account created successfully! Please sign in.");
          reset();
          router.push("/auth/signin");
          
        } else {
          // Login
          const loginData = data as LoginFormData;
          
          const result = await signIn("credentials", {
            email: loginData.email,
            password: loginData.password,
            redirect: false,
          });

          if (result?.error) {
            throw new Error("Invalid credentials");
          }

          if (result?.ok) {
            toast.success("Signed in successfully!");
            
            // Get updated session and redirect
            const session = await getSession();
            if (session?.user) {
              router.push("/dashboard");
              router.refresh();
            }
          }
        }
      } catch (error) {
        console.error("Auth error:", error);
        toast.error(error instanceof Error ? error.message : "Authentication failed");
      } finally {
        setIsLoading(false);
      }
    };

    const handleOAuthSignIn = async (provider: "google" | "github") => {
      try {
        setIsLoading(true);
        await signIn(provider, { 
          callbackUrl: "/dashboard",
          redirect: true 
        });
      } catch (error) {
        console.error("OAuth error:", error);
        toast.error("OAuth sign-in failed");
        setIsLoading(false);
      }
    };

    return (
      <div className="w-full max-w-md mx-auto space-y-6">
        <div className="text-center">
          <h1 className="text-2xl font-bold">
            {mode === "login" ? "Sign In" : "Create Account"}
          </h1>
          <p className="text-gray-600 mt-2">
            {mode === "login" 
              ? "Welcome back! Please sign in to continue." 
              : "Join us today! Create your account to get started."}
          </p>
        </div>

        {/* OAuth Buttons */}
        <div className="space-y-3">
          <button
            type="button"
            onClick={() => handleOAuthSignIn("google")}
            disabled={isLoading}
            className="w-full flex items-center justify-center gap-3 px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
          >
            <svg className="w-5 h-5" viewBox="0 0 24 24">
              <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
              <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
              <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Continue with Google
          </button>
          
          <button
            type="button"
            onClick={() => handleOAuthSignIn("github")}
            disabled={isLoading}
            className="w-full flex items-center justify-center gap-3 px-4 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
          >
            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
            Continue with GitHub
          </button>
        </div>

        <div className="relative">
          <div className="absolute inset-0 flex items-center">
            <div className="w-full border-t border-gray-300" />
          </div>
          <div className="relative flex justify-center text-sm">
            <span className="px-2 bg-white text-gray-500">Or continue with email</span>
          </div>
        </div>

        {/* Email/Password Form */}
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {mode === "register" && (
            <div>
              <label htmlFor="username" className="block text-sm font-medium text-gray-700 mb-1">
                Username
              </label>
              <input
                {...register("username" as keyof (LoginFormData | RegisterFormData))}
                type="text"
                id="username"
                className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="Enter your username"
              />
              {errors.username && (
                <p className="mt-1 text-sm text-red-600">{errors.username.message}</p>
              )}
            </div>
          )}

          <div>
            <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-1">
              Email Address
            </label>
            <input
              {...register("email")}
              type="email"
              id="email"
              className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="Enter your email"
            />
            {errors.email && (
              <p className="mt-1 text-sm text-red-600">{errors.email.message}</p>
            )}
          </div>

          <div>
            <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">
              Password
            </label>
            <input
              {...register("password")}
              type="password"
              id="password"
              className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="Enter your password"
            />
            {errors.password && (
              <p className="mt-1 text-sm text-red-600">{errors.password.message}</p>
            )}
          </div>

          {mode === "register" && (
            <div>
              <label htmlFor="confirmPassword" className="block text-sm font-medium text-gray-700 mb-1">
                Confirm Password
              </label>
              <input
                {...register("confirmPassword" as keyof (LoginFormData | RegisterFormData))}
                type="password"
                id="confirmPassword"
                className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="Confirm your password"
              />
              {errors.confirmPassword && (
                <p className="mt-1 text-sm text-red-600">{errors.confirmPassword.message}</p>
              )}
            </div>
          )}

          <button
            type="submit"
            disabled={isLoading}
            className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isLoading ? (
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                {mode === "login" ? "Signing In..." : "Creating Account..."}
              </div>
            ) : (
              mode === "login" ? "Sign In" : "Create Account"
            )}
          </button>
        </form>

        <div className="text-center">
          <p className="text-sm text-gray-600">
            {mode === "login" ? "Don't have an account? " : "Already have an account? "}
            <Link
              href={mode === "login" ? "/auth/register" : "/auth/signin"}
              className="font-medium text-indigo-600 hover:text-indigo-500"
            >
              {mode === "login" ? "Sign up" : "Sign in"}
            </Link>
          </p>
        </div>
      </div>
    );
  }
  ```
</CodeCollapsibleWrapper>

### Authentication Pages

Create the sign-in page at `src/app/auth/signin/page.tsx`:

```typescript
import AuthForm from "@/components/auth/AuthForm";

export default function SignInPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <AuthForm mode="login" />
    </div>
  );
}
```

Create the register page at `src/app/auth/register/page.tsx`:

```typescript
import AuthForm from "@/components/auth/AuthForm";

export default function RegisterPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
      <AuthForm mode="register" />
    </div>
  );
}
```

### User Dashboard

Create a protected dashboard at `src/app/dashboard/page.tsx`:

<CodeCollapsibleWrapper>
  ```typescript
  import { redirect } from "next/navigation";
  import { getServerSession } from "next-auth";
  import { authOptions } from "@/app/api/auth/[...nextauth]/route";
  import UserProfile from "@/components/dashboard/UserProfile";

  export default async function DashboardPage() {
    const session = await getServerSession(authOptions);

    if (!session?.user) {
      redirect("/auth/signin");
    }

    return (
      <div className="min-h-screen bg-gray-50">
        <header className="bg-white shadow">
          <div className="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
            <h1 className="text-3xl font-bold text-gray-900">Dashboard</h1>
          </div>
        </header>
        
        <main className="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
          <div className="px-4 py-6 sm:px-0">
            <UserProfile user={session.user} />
          </div>
        </main>
      </div>
    );
  }
  ```
</CodeCollapsibleWrapper>

Create the user profile component at `src/components/dashboard/UserProfile.tsx`:

<CodeCollapsibleWrapper>
  ```typescript
  "use client";

  import { signOut } from "next-auth/react";
  import { toast } from "sonner";

  interface Props {
    user: {
      id: string;
      username: string;
      email: string;
      role: string;
      image?: string;
    };
  }

  export default function UserProfile({ user }: Props) {
    const handleSignOut = async () => {
      try {
        await signOut({ 
          callbackUrl: "/auth/signin",
          redirect: true 
        });
        toast.success("Signed out successfully");
      } catch (error) {
        toast.error("Error signing out");
      }
    };

    return (
      <div className="bg-white overflow-hidden shadow rounded-lg">
        <div className="px-4 py-5 sm:p-6">
          <div className="sm:flex sm:items-center sm:justify-between">
            <div className="sm:flex sm:space-x-5">
              <div className="flex-shrink-0">
                <div className="mx-auto h-20 w-20 rounded-full bg-indigo-100 flex items-center justify-center">
                  {user.image ? (
                    <img
                      className="h-20 w-20 rounded-full"
                      src={user.image}
                      alt={user.username}
                    />
                  ) : (
                    <span className="text-xl font-semibold text-indigo-600">
                      {user.username.charAt(0).toUpperCase()}
                    </span>
                  )}
                </div>
              </div>
              <div className="mt-4 text-center sm:mt-0 sm:pt-1 sm:text-left">
                <p className="text-sm font-medium text-gray-600">Welcome back,</p>
                <p className="text-xl font-bold text-gray-900 sm:text-2xl">
                  {user.username}
                </p>
                <p className="text-sm text-gray-600">{user.email}</p>
                <div className="mt-1">
                  <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                    user.role === 'admin' 
                      ? 'bg-purple-100 text-purple-800' 
                      : 'bg-green-100 text-green-800'
                  }`}>
                    {user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                  </span>
                </div>
              </div>
            </div>
            <div className="mt-5 flex justify-center sm:mt-0">
              <button
                onClick={handleSignOut}
                className="flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                Sign Out
              </button>
            </div>
          </div>
          
          <div className="mt-8">
            <h3 className="text-lg font-medium text-gray-900">Account Information</h3>
            <dl className="mt-4 border-t border-gray-200 pt-4 space-y-4">
              <div>
                <dt className="text-sm font-medium text-gray-500">User ID</dt>
                <dd className="mt-1 text-sm text-gray-900">{user.id}</dd>
              </div>
              <div>
                <dt className="text-sm font-medium text-gray-500">Username</dt>
                <dd className="mt-1 text-sm text-gray-900">{user.username}</dd>
              </div>
              <div>
                <dt className="text-sm font-medium text-gray-500">Email</dt>
                <dd className="mt-1 text-sm text-gray-900">{user.email}</dd>
              </div>
              <div>
                <dt className="text-sm font-medium text-gray-500">Role</dt>
                <dd className="mt-1 text-sm text-gray-900">{user.role}</dd>
              </div>
            </dl>
          </div>
        </div>
      </div>
    );
  }
  ```
</CodeCollapsibleWrapper>

---
## 5. Route Protection

### Middleware Setup

Create middleware for route protection at `src/middleware.ts`:

<CodeCollapsibleWrapper>
  ```typescript
  import { withAuth } from "next-auth/middleware";
  import { NextResponse } from "next/server";

  export default withAuth(
    function middleware(req) {
      const { pathname } = req.nextUrl;
      const token = req.nextauth.token;

      // Admin routes protection
      if (pathname.startsWith("/admin")) {
        if (!token || token.role !== "admin") {
          return NextResponse.redirect(new URL("/auth/signin", req.url));
        }
      }

      // Protected routes
      const protectedRoutes = ["/dashboard", "/profile", "/settings"];
      const isProtectedRoute = protectedRoutes.some(route => 
        pathname.startsWith(route)
      );

      if (isProtectedRoute && !token) {
        return NextResponse.redirect(new URL("/auth/signin", req.url));
      }

      return NextResponse.next();
    },
    {
      callbacks: {
        authorized: ({ token, req }) => {
          const { pathname } = req.nextUrl;
          
          // Allow access to auth pages
          if (pathname.startsWith("/auth")) {
            return true;
          }
          
          // Require token for protected routes
          return !!token;
        },
      },
    }
  );

  export const config = {
    matcher: [
      "/dashboard/:path*",
      "/profile/:path*", 
      "/settings/:path*",
      "/admin/:path*",
      "/auth/:path*"
    ],
  };
  ```
</CodeCollapsibleWrapper>

### Auth Guard Component

Create a client-side auth guard at `src/components/auth/AuthGuard.tsx`:

<CodeCollapsibleWrapper>
  ```typescript
  "use client";

  import { useSession } from "next-auth/react";
  import { useRouter } from "next/navigation";
  import { useEffect, ReactNode } from "react";

  interface Props {
    children: ReactNode;
    roles?: string[];
    fallbackUrl?: string;
  }

  export default function AuthGuard({ 
    children, 
    roles = [], 
    fallbackUrl = "/auth/signin" 
  }: Props) {
    const { data: session, status } = useSession();
    const router = useRouter();

    useEffect(() => {
      if (status === "loading") return; // Still loading

      // Not authenticated
      if (!session?.user) {
        router.push(fallbackUrl);
        return;
      }

      // Check role requirements
      if (roles.length > 0 && !roles.includes(session.user.role)) {
        router.push("/unauthorized");
        return;
      }
    }, [session, status, router, roles, fallbackUrl]);

    // Show loading state
    if (status === "loading") {
      return (
        <div className="min-h-screen flex items-center justify-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
        </div>
      );
    }

    // Show nothing while redirecting
    if (!session?.user) {
      return null;
    }

    // Check role authorization
    if (roles.length > 0 && !roles.includes(session.user.role)) {
      return null;
    }

    return <>{children}</>;
  }
  ```
</CodeCollapsibleWrapper>

### Protected Route Hook

Create a custom hook for protected routes at `src/hooks/useAuth.ts`:

<CodeCollapsibleWrapper>
 ```typescript
  "use client";

  import { useSession } from "next-auth/react";
  import { useRouter } from "next/navigation";
  import { useEffect } from "react";

  export function useAuth(options: {
    required?: boolean;
    redirectTo?: string;
    roles?: string[];
  } = {}) {
    const { data: session, status } = useSession();
    const router = useRouter();
    
    const { 
      required = false, 
      redirectTo = "/auth/signin",
      roles = [] 
    } = options;

    useEffect(() => {
      if (status === "loading") return;

      if (required && !session?.user) {
        router.push(redirectTo);
        return;
      }

      if (
        session?.user && 
        roles.length > 0 && 
        !roles.includes(session.user.role)
      ) {
        router.push("/unauthorized");
        return;
      }
    }, [session, status, required, redirectTo, roles, router]);

    return {
      user: session?.user,
      isLoading: status === "loading",
      isAuthenticated: !!session?.user,
      hasRole: (role: string) => session?.user?.role === role,
    };
  }
  ```
</CodeCollapsibleWrapper>

---

## Conclusion

Congratulations! ðŸŽ‰ You've successfully built a complete full-stack authentication system with:

### âœ… What You've Accomplished

- **Full-Stack Architecture**: Complete Next.js app with TypeScript
- **Secure Authentication**: NextAuth with multiple providers
- **Database Integration**: MongoDB with Mongoose ODM
- **Form Validation**: Zod schemas with React Hook Form
- **Route Protection**: Middleware and client-side guards
- **Professional UI**: Responsive authentication forms
- **Error Handling**: Comprehensive error management
- **Production Ready**: Deployment and security best practices

### ðŸš€ Next Steps

Consider extending your application with:

1. **Email Verification**: Add email confirmation for new accounts
2. **Password Reset**: Implement forgot password functionality  
3. **Two-Factor Auth**: Add 2FA for enhanced security
4. **User Management**: Admin panel for user management
5. **API Rate Limiting**: Implement rate limiting middleware
6. **Audit Logging**: Track user activities and security events
7. **Social Features**: User profiles, avatars, preferences
8. **Real-time Features**: WebSocket integration with auth

### ðŸ“š Additional Resources

- [NextAuth.js Documentation](https://next-auth.js.org/)
- [MongoDB Atlas Documentation](https://docs.atlas.mongodb.com/)
- [Next.js Documentation](https://nextjs.org/docs)
- [Zod Documentation](https://zod.dev/)
- [React Hook Form Documentation](https://react-hook-form.com/)

Happy coding! ðŸš€